<div class="container-fluid" *ngIf="booth">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0">
      <i class="fas fa-calendar-alt me-2"></i>
      Rent Booth #{{ booth.number }}
    </h2>
    <div class="text-muted">
      <small>Select rental period (minimum 7 days)</small>
      <br>
      <small *ngIf="minimumGapDays > 0" class="text-info">
        <i class="fas fa-info-circle me-1"></i>
        Minimum gap between rentals: {{ minimumGapDays }} days
      </small>
    </div>
  </div>

  <!-- Booth Info Card -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <h5 class="card-title">
            <i class="fas fa-store me-2"></i>
            Booth Details
          </h5>
          <p class="mb-2"><strong>Price per day:</strong>
            <span class="text-success fw-bold">{{ booth.pricePerDay | currency:booth.currencyDisplayName:'symbol':'1.2-2' }}</span>
          </p>
          <p class="mb-0"><strong>Description:</strong> {{ booth.description || 'No description available' }}</p>
        </div>
        <div class="col-md-6" *ngIf="selectedStartDate && selectedEndDate">
          <h5 class="card-title">
            <i class="fas fa-receipt me-2"></i>
            Booking Summary
          </h5>
          <div class="table-responsive">
            <table class="table table-sm table-borderless">
              <tr>
                <td><strong>Period:</strong></td>
                <td>{{ selectedStartDate | date:'shortDate' }} - {{ selectedEndDate | date:'shortDate' }}</td>
              </tr>
              <tr>
                <td><strong>Days:</strong></td>
                <td>{{ calculatedDays }}</td>
              </tr>
              <tr class="table-success">
                <td><strong>Total Price:</strong></td>
                <td class="fw-bold">{{ calculatedPrice | currency:booth.currencyDisplayName:'symbol':'1.2-2' }}</td>
              </tr>
              <tr *ngIf="selectedBoothType">
                <td><strong>Commission:</strong></td>
                <td><span class="badge bg-info">{{ selectedBoothType.commissionPercentage }}%</span></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booth Type Selection -->
  <div class="card mb-4" *ngIf="boothTypes.length > 0">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-tags me-2"></i>
        Select Booth Type
      </h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="boothTypeSelect" class="form-label">Choose your booth type</label>
          <select id="boothTypeSelect" class="form-select" [(ngModel)]="selectedBoothType" (change)="onBoothTypeChange()">
            <option [ngValue]="undefined">Select a booth type...</option>
            <option *ngFor="let boothType of boothTypes" [ngValue]="boothType">
              {{ boothType.name }} ({{ boothType.commissionPercentage }}% commission)
            </option>
          </select>
        </div>
        <div class="col-md-6" *ngIf="selectedBoothType">
          <label class="form-label">Description</label>
          <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            {{ selectedBoothType.description }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Navigation -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-secondary" (click)="prevMonth()">
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <h4 class="mb-0">
          <i class="fas fa-calendar me-2"></i>
          {{ getMonthYear() }}
        </h4>
        <button class="btn btn-outline-secondary" (click)="nextMonth()">
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="text-center">
        <button class="btn btn-sm btn-outline-primary me-2" (click)="goToToday()">
          <i class="fas fa-home me-1"></i>Today
        </button>
        <button class="btn btn-sm btn-outline-warning" (click)="clearSelection()">
          <i class="fas fa-times me-1"></i>Clear Selection
        </button>
      </div>
    </div>
  </div>

  <!-- Calendar Grid -->
  <div class="card mb-4">
    <div class="card-body p-0">
      <div class="calendar-grid">
        <!-- Day Headers -->
        <div class="day-header">Sun</div>
        <div class="day-header">Mon</div>
        <div class="day-header">Tue</div>
        <div class="day-header">Wed</div>
        <div class="day-header">Thu</div>
        <div class="day-header">Fri</div>
        <div class="day-header">Sat</div>

        <!-- Calendar Days -->
        <div *ngFor="let day of calendarDays"
             [class]="getDayClass(day)"
             (click)="onDayClick(day)"
             [title]="getDateTooltip(day)">
          <span class="day-number">{{ day.date.getDate() }}</span>
          <div class="day-indicators" *ngIf="day.status !== CalendarDateStatus.Available && day.status !== CalendarDateStatus.PastDate">
            <small class="status-text">{{ day.statusDisplayName }}</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Legend -->
  <div class="card mb-4" *ngIf="calendarLegend && getCalendarStatuses().length > 0">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-info-circle me-2"></i>
        Calendar Legend
      </h5>
      <div class="row g-2">
        <div class="col-md-6" *ngFor="let statusKey of getCalendarStatuses()">
          <div class="d-flex align-items-center">
            <div class="legend-color-box" [ngClass]="getLegendClass(statusKey)"></div>
            <span class="ms-2">{{ calendarLegend[statusKey] }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selection Info -->
  <div class="card mb-4" *ngIf="selectedStartDate">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-check-circle me-2"></i>
        Current Selection
      </h5>
      <div *ngIf="!selectedEndDate" class="alert alert-warning">
        <strong>Start Date:</strong> {{ selectedStartDate | date:'fullDate' }}
        <br>
        <small><i class="fas fa-info-circle me-1"></i>Click another date to complete your selection (minimum 7 days)</small>
      </div>
      <div *ngIf="selectedEndDate">
        <div class="row g-3">
          <div class="col-md-6">
            <p class="mb-2"><strong>Period:</strong> {{ selectedStartDate | date:'shortDate' }} to {{ selectedEndDate | date:'shortDate' }}</p>
            <p class="mb-0"><strong>Duration:</strong> {{ calculatedDays }} days</p>
          </div>
          <div class="col-md-6" *ngIf="calculatedDays < 7">
            <div class="alert alert-danger mb-0">
              <i class="fas fa-exclamation-triangle me-1"></i>
              Minimum rental period is 7 days
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Action -->
  <div class="card" *ngIf="selectedStartDate && selectedEndDate && calculatedDays >= 7">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-credit-card me-2"></i>
        Complete Your Booking
      </h5>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>Item</th>
                  <th class="text-end">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ calculatedDays }} days Ã— {{ booth.pricePerDay | currency:booth.currencyDisplayName:'symbol':'1.2-2' }}</td>
                  <td class="text-end">{{ calculatedPrice | currency:booth.currencyDisplayName:'symbol':'1.2-2' }}</td>
                </tr>
                <tr class="table-success">
                  <td><strong>Total Amount</strong></td>
                  <td class="text-end"><strong>{{ calculatedPrice | currency:booth.currencyDisplayName:'symbol':'1.2-2' }}</strong></td>
                </tr>
              </tbody>
            </table>
            <div class="alert alert-info" *ngIf="selectedBoothType">
              <i class="fas fa-info-circle me-2"></i>
              <small>Commission rate: <strong>{{ selectedBoothType.commissionPercentage }}%</strong> will be applied on your sales</small>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="w-100">
            <!-- Notes Field -->
            <div class="mb-3">
              <label for="bookingNotes" class="form-label">
                <i class="fas fa-comment me-2"></i>
                Notes (Optional)
              </label>
              <textarea
                id="bookingNotes"
                class="form-control"
                [(ngModel)]="notes"
                rows="3"
                placeholder="Add any additional notes or special requests..."></textarea>
            </div>
            <button class="btn btn-success btn-lg w-100 mb-3"
                    [disabled]="!canProceedToPayment()"
                    [pTooltip]="hasGapError ? gapErrorMessage : ''"
                    tooltipPosition="top"
                    [escape]="false"
                    (click)="addOrUpdateCart()">
              <i class="pi me-2" [ngClass]="isEditingCartItem ? 'pi-refresh' : 'pi-cart-plus'"></i>
              {{ isEditingCartItem ? 'Update Cart' : 'Add to Cart' }}
            </button>
            <div class="alert alert-danger mb-3" *ngIf="hasGapError">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Cannot add to cart:</strong>
              <div class="mt-2">{{ gapErrorMessage }}</div>
            </div>
            <button class="btn btn-outline-primary btn-lg w-100 mb-3"
                    (click)="router.navigate(['/cart'])">
              <i class="pi pi-shopping-cart me-2"></i>View Cart ({{ cartService.itemCount }})
            </button>
            <div *ngIf="!selectedBoothType && !hasGapError" class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Please select a booth type to continue
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading state -->
<div class="container-fluid" *ngIf="loading">
  <div class="card">
    <div class="card-body text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading booth details...</p>
    </div>
  </div>
</div>

<!-- Payment Selection Dialog -->
<app-payment-selection
  [visible]="showPaymentSelection"
  [amount]="calculatedPrice"
  [currency]="booth?.currencyDisplayName || 'PLN'"
  (paymentSelected)="onPaymentSelected($event)"
  (cancelled)="onPaymentCancelled()">
</app-payment-selection>