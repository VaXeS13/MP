<div class="container-fluid" *ngIf="booth">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4" *ngIf="!hideBoothInfo">
    <h2 class="h3 mb-0">
      <i class="fas fa-calendar-alt me-2"></i>
      Rent Booth #{{ booth.number }}
    </h2>
    <div class="text-muted">
      <small>Select rental period (minimum {{ minimumRentalDays }} days)</small>
      <br>
      <small *ngIf="minimumGapDays > 0" class="text-info">
        <i class="fas fa-info-circle me-1"></i>
        Minimum gap between rentals: {{ minimumGapDays }} days
      </small>
    </div>
  </div>

  <!-- Booth Info Card -->
  <div class="card mb-4" *ngIf="!hideBoothInfo">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <h5 class="card-title">
            <i class="fas fa-store me-2"></i>
            Booth Details
          </h5>
          <p class="mb-2"><strong>Pricing:</strong>
            <span class="text-success fw-bold">{{ getPricingPeriodsDisplay() }}</span>
          </p>
          <p class="mb-0"><strong>Description:</strong> {{ booth.description || 'No description available' }}</p>
        </div>
        <div class="col-md-6" *ngIf="selectedStartDate && selectedEndDate">
          <h5 class="card-title">
            <i class="fas fa-receipt me-2"></i>
            Booking Summary
          </h5>
          <div class="table-responsive">
            <table class="table table-sm table-borderless">
              <tr>
                <td><strong>Period:</strong></td>
                <td>{{ selectedStartDate | date:'shortDate' }} - {{ selectedEndDate | date:'shortDate' }}</td>
              </tr>
              <tr>
                <td><strong>Days:</strong></td>
                <td>{{ calculatedDays }}</td>
              </tr>
              <tr class="table-success">
                <td><strong>Total Price:</strong></td>
                <td class="fw-bold">
                  {{ calculatedPrice | currency:tenantCurrencyCode:'symbol':'1.2-2' }}
                  <i *ngIf="hasPriceBreakdown()"
                     class="pi pi-info-circle ms-2 price-breakdown-icon"
                     [pTooltip]="getPriceBreakdownTooltip()"
                     [escape]="false"
                     tooltipPosition="right"
                     [tooltipOptions]="{showDelay: 200}"></i>
                </td>
              </tr>
              <tr *ngIf="selectedBoothType">
                <td><strong>Commission:</strong></td>
                <td><span class="badge bg-info">{{ selectedBoothType.commissionPercentage }}%</span></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booth Type Selection -->
  <div class="card mb-4" *ngIf="boothTypes.length > 0 && !hideBoothTypeSelection">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-tags me-2"></i>
        Select Booth Type
      </h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="boothTypeSelect" class="form-label">Choose your booth type</label>
          <select id="boothTypeSelect" class="form-select" [(ngModel)]="selectedBoothType" (change)="onBoothTypeChange()">
            <option [ngValue]="undefined">Select a booth type...</option>
            <option *ngFor="let boothType of boothTypes; trackBy: trackByBoothTypeId" [ngValue]="boothType">
              {{ boothType.name }} ({{ boothType.commissionPercentage }}% commission)
            </option>
          </select>
        </div>
        <div class="col-md-6" *ngIf="selectedBoothType">
          <label class="form-label">Description</label>
          <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            {{ selectedBoothType.description }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Items for This Booth -->
  <div class="card mb-4" *ngIf="currentCartItems.length > 0 && mode === 'user' && !excludeCartId">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <i class="pi pi-shopping-cart me-2"></i>
          <strong>Your Reservations for Booth {{ booth?.number }}</strong>
          <span class="badge bg-white text-primary ms-2">{{ currentCartItems.length }}</span>
        </div>
        <div>
          <span class="badge bg-success me-2" *ngIf="activeReservationsCount > 0">
            {{ activeReservationsCount }} Active
          </span>
          <span class="badge bg-warning text-dark" *ngIf="expiredReservationsCount > 0">
            {{ expiredReservationsCount }} Expired
          </span>
        </div>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="list-group list-group-flush">
        <div *ngFor="let item of currentCartItems; trackBy: trackByCartItemId"
             class="list-group-item cart-item-card"
             [class.selected-item]="isCartItemSelected(item)"
             [class.dimmed-item]="isCartItemDimmed(item)"
             [class.border-start]="true"
             [class.border-warning]="isReservationExpired(item)"
             [class.border-success]="isReservationActive(item)"
             [class.border-4]="true"
             (click)="editCartItem(item)"
             style="cursor: pointer;">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1" style="pointer-events: none;">
              <!-- Dates -->
              <div class="fw-bold mb-1">
                <i class="pi pi-calendar me-1"></i>
                {{ item.startDate | date:'mediumDate' }} - {{ item.endDate | date:'mediumDate' }}
                <span class="badge bg-secondary ms-2">{{ item.daysCount }} days</span>
              </div>

              <!-- Price -->
              <div class="text-muted mb-1">
                <i class="pi pi-tag me-1"></i>
                {{ item.totalPrice | currency:item.currency }}
              </div>

              <!-- Reservation Status -->
              <div class="mb-1">
                <!-- Active Reservation -->
                <small class="text-success fw-bold"
                       *ngIf="isReservationActive(item)">
                  <i class="pi pi-check-circle me-1"></i>
                  Reserved until: <strong>{{ item.reservationExpiresAt | date:'short' }}</strong>
                  <span class="ms-2 countdown-text">({{ getCountdown(item.id) }} remaining)</span>
                </small>

                <!-- Expired Reservation -->
                <small class="text-warning fw-bold"
                       *ngIf="isReservationExpired(item)">
                  <i class="pi pi-exclamation-triangle me-1"></i>
                  Reservation expired - booth may no longer be available
                </small>

                <!-- No Reservation (shouldn't happen normally) -->
                <small class="text-muted" *ngIf="!item.reservationExpiresAt">
                  <i class="pi pi-info-circle me-1"></i>
                  No active reservation
                </small>
              </div>

              <!-- Notes -->
              <div class="text-muted small" *ngIf="item.notes">
                <i class="pi pi-comment me-1"></i>
                {{ item.notes }}
              </div>
            </div>

            <!-- Actions -->
            <div class="ms-3" style="pointer-events: auto;">
              <button type="button"
                      class="btn btn-sm btn-outline-danger"
                      (click)="$event.stopPropagation(); removeCartItem(item)"
                      pTooltip="Remove from cart"
                      tooltipPosition="left">
                <i class="pi pi-trash me-1"></i>
                Remove
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add New Period Button or Cancel Editing -->
      <div class="card-footer bg-light">
        <!-- Cancel Editing button when item is selected -->
        <button type="button"
                *ngIf="selectedCartItemId"
                class="btn btn-outline-warning w-100"
                (click)="cancelEditingCartItem()">
          <i class="pi pi-times me-2"></i>
          Cancel Editing
        </button>

        <!-- Add New Period button when no item is selected -->
        <button type="button"
                *ngIf="!selectedCartItemId"
                class="btn btn-outline-success w-100"
                (click)="startNewReservation()">
          <i class="pi pi-plus me-2"></i>
          Add New Period for This Booth
        </button>
      </div>
    </div>
  </div>

  <!-- Calendar Navigation -->
  <div class="card mb-4" *ngIf="!hideCalendarNavigation">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-secondary" (click)="prevMonth()">
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <h4 class="mb-0">
          <i class="fas fa-calendar me-2"></i>
          {{ getMonthYear() }}
        </h4>
        <button class="btn btn-outline-secondary" (click)="nextMonth()">
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="text-center">
        <button class="btn btn-sm btn-outline-primary me-2" (click)="goToToday()">
          <i class="fas fa-home me-1"></i>Today
        </button>
        <button class="btn btn-sm btn-outline-warning" (click)="clearSelection()">
          <i class="fas fa-times me-1"></i>Clear Selection
        </button>
      </div>
    </div>
  </div>

  <!-- Simple Calendar Header (for admin mode) -->
  <div class="d-flex justify-content-between align-items-center mb-3" *ngIf="hideCalendarNavigation">
    <button class="btn btn-sm btn-outline-secondary" (click)="prevMonth()">
      <i class="fas fa-chevron-left"></i>
    </button>
    <h5 class="mb-0">{{ getMonthYear() }}</h5>
    <button class="btn btn-sm btn-outline-secondary" (click)="nextMonth()">
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>

  <!-- Calendar Grid -->
  <div class="card mb-4">
    <div class="card-body p-0">
      <div class="calendar-grid">
        <!-- Day Headers -->
        <div class="day-header">Sun</div>
        <div class="day-header">Mon</div>
        <div class="day-header">Tue</div>
        <div class="day-header">Wed</div>
        <div class="day-header">Thu</div>
        <div class="day-header">Fri</div>
        <div class="day-header">Sat</div>

        <!-- Calendar Days -->
        <div *ngFor="let day of calendarDays; trackBy: trackByIndex"
             [class]="getDayClass(day)"
             (click)="onDayClick(day)"
             [title]="getDateTooltip(day)">
          <span class="day-number">{{ day.date.getDate() }}</span>
          <div class="day-indicators" *ngIf="day.status !== CalendarDateStatus.Available && day.status !== CalendarDateStatus.PastDate">
            <small class="status-text">{{ day.statusDisplayName }}</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Legend -->
  <div class="card mb-4" *ngIf="calendarLegend && getCalendarStatuses().length > 0 && !hideLegend">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-info-circle me-2"></i>
        Calendar Legend
      </h5>
      <div class="row g-2">
        <div class="col-md-6" *ngFor="let statusKey of getCalendarStatuses(); trackBy: trackByStatusKey">
          <div class="d-flex align-items-center">
            <div class="legend-color-box" [ngClass]="getLegendClass(statusKey)"></div>
            <span class="ms-2">{{ calendarLegend[statusKey] }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selection Info -->
  <div class="card mb-4" *ngIf="selectedStartDate">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-check-circle me-2"></i>
        Current Selection
      </h5>
      <div *ngIf="!selectedEndDate" class="alert alert-warning">
        <strong>Start Date:</strong> {{ selectedStartDate | date:'fullDate' }}
        <br>
        <small><i class="fas fa-info-circle me-1"></i>Click another date to complete your selection (minimum {{ minimumRentalDays }} days)</small>
      </div>
      <div *ngIf="selectedEndDate">
        <div class="row g-3">
          <div class="col-md-6">
            <p class="mb-2"><strong>Period:</strong> {{ selectedStartDate | date:'shortDate' }} to {{ selectedEndDate | date:'shortDate' }}</p>
            <p class="mb-0"><strong>Duration:</strong> {{ calculatedDays }} days</p>
          </div>
          <div class="col-md-6" *ngIf="calculatedDays < minimumRentalDays">
            <div class="alert alert-danger mb-0">
              <i class="fas fa-exclamation-triangle me-1"></i>
              Minimum rental period is {{ minimumRentalDays }} days
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Action -->
  <div class="card" *ngIf="selectedStartDate && selectedEndDate && calculatedDays >= minimumRentalDays && !hidePaymentActions">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-credit-card me-2"></i>
        Complete Your Booking
      </h5>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>Item</th>
                  <th class="text-end">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td [innerHTML]="getPriceBreakdownText()"></td>
                  <td class="text-end">{{ calculatedPrice | currency:tenantCurrencyCode:'symbol':'1.2-2' }}</td>
                </tr>
                <tr class="table-success">
                  <td><strong>Total Amount</strong></td>
                  <td class="text-end"><strong>{{ calculatedPrice | currency:tenantCurrencyCode:'symbol':'1.2-2' }}</strong></td>
                </tr>
              </tbody>
            </table>
            <div class="alert alert-info" *ngIf="selectedBoothType">
              <i class="fas fa-info-circle me-2"></i>
              <small>Commission rate: <strong>{{ selectedBoothType.commissionPercentage }}%</strong> will be applied on your sales</small>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="w-100">
            <!-- Notes Field -->
            <div class="mb-3">
              <label for="bookingNotes" class="form-label">
                <i class="fas fa-comment me-2"></i>
                Notes (Optional)
              </label>
              <textarea
                id="bookingNotes"
                class="form-control"
                [(ngModel)]="notes"
                rows="3"
                placeholder="Add any additional notes or special requests..."></textarea>
            </div>
            <button class="btn btn-lg w-100 mb-3"
                    [ngClass]="isEditingCartItem ? 'btn-warning' : 'btn-success'"
                    [disabled]="!canProceedToPayment()"
                    [pTooltip]="hasGapError ? gapErrorMessage : ''"
                    tooltipPosition="top"
                    [escape]="false"
                    (click)="addOrUpdateCart()">
              <i class="pi me-2" [ngClass]="isEditingCartItem ? 'pi-refresh' : 'pi-cart-plus'"></i>
              <span *ngIf="isEditingCartItem">Update Selected Reservation</span>
              <span *ngIf="!isEditingCartItem && currentCartItems.length > 0">Add Additional Period</span>
              <span *ngIf="!isEditingCartItem && currentCartItems.length === 0">Add to Cart</span>
            </button>
            <div class="alert alert-danger mb-3" *ngIf="hasGapError">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Cannot add to cart:</strong>
              <div class="mt-2">{{ gapErrorMessage }}</div>
            </div>
            <button class="btn btn-outline-primary btn-lg w-100 mb-3"
                    (click)="router.navigate(['/cart'])">
              <i class="pi pi-shopping-cart me-2"></i>View Cart ({{ cartService.itemCount }})
            </button>
            <div *ngIf="!selectedBoothType && !hasGapError" class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Please select a booth type to continue
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading state -->
<div class="container-fluid" *ngIf="loading">
  <div class="card">
    <div class="card-body text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading booth details...</p>
    </div>
  </div>
</div>

<!-- Payment Selection Dialog (only in user mode) -->
<app-payment-selection
  *ngIf="mode === 'user'"
  [visible]="showPaymentSelection"
  [amount]="calculatedPrice"
  [currency]="tenantCurrencyCode"
  (paymentSelected)="onPaymentSelected($event)"
  (cancelled)="onPaymentCancelled()">
</app-payment-selection>