<p-dialog
  header="Select Payment Method"
  [(visible)]="visible"
  (visibleChange)="onVisibleChange()"
  [modal]="true"
  [closable]="true"
  [resizable]="false"
  styleClass="payment-selection-dialog"
  [style]="{width: '600px', maxWidth: '90vw'}">

  <!-- Provider Selection Step -->
  <div *ngIf="step === 'provider'">
    <h4 class="mb-3">Choose Payment Provider</h4>
    <div class="payment-amount mb-4">
      <div class="text-center">
        <span class="amount-label">Amount to pay:</span>
        <div class="amount-value">{{ amount | currency:currency:'symbol':'1.2-2' }}</div>
      </div>
    </div>

    <!-- Loading providers -->
    <div *ngIf="loadingProviders" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading payment providers...</p>
    </div>

    <!-- Provider cards -->
    <div *ngIf="!loadingProviders" class="providers-grid">
      <div
        *ngFor="let provider of providers"
        class="provider-card"
        [class.selected]="selectedProvider?.id === provider.id"
        (click)="selectProvider(provider)">
        <div class="provider-logo">
          <img [src]="provider.logoUrl" [alt]="provider.displayName" />
        </div>
        <div class="provider-info">
          <h5>{{ provider.displayName }}</h5>
          <p class="provider-description" *ngIf="provider.description">{{ provider.description }}</p>
          <div class="supported-currencies" *ngIf="provider.supportedCurrencies.length">
            <small class="text-muted">
              Supports: {{ provider.supportedCurrencies.join(', ') }}
            </small>
          </div>
        </div>
        <div class="selection-indicator">
          <i class="fas fa-check-circle" *ngIf="selectedProvider?.id === provider.id"></i>
        </div>
      </div>
    </div>

    <!-- No providers available -->
    <div *ngIf="!loadingProviders && providers.length === 0" class="text-center py-5">
      <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
      <h5>No Payment Providers Available</h5>
      <p class="text-muted">Please contact support for assistance.</p>
    </div>
  </div>

  <!-- Payment Method Selection Step -->
  <div *ngIf="step === 'method'">
    <div class="d-flex align-items-center mb-3">
      <button type="button" class="btn btn-link p-0 me-3" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h4 class="mb-0">Select Payment Method</h4>
    </div>

    <div class="selected-provider mb-4">
      <div class="d-flex align-items-center">
        <img [src]="selectedProvider!.logoUrl" [alt]="selectedProvider!.displayName" class="provider-logo-small me-3" />
        <div>
          <strong>{{ selectedProvider!.displayName }}</strong>
          <div class="amount-small">{{ amount | currency:currency:'symbol':'1.2-2' }}</div>
        </div>
      </div>
    </div>

    <!-- Loading methods -->
    <div *ngIf="loadingMethods" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading payment methods...</p>
    </div>

    <!-- Payment methods -->
    <div *ngIf="!loadingMethods" class="methods-list">
      <div
        *ngFor="let method of availableMethods"
        class="method-card"
        [class.selected]="selectedMethod?.id === method.id"
        (click)="selectMethod(method)">
        <div class="method-icon">
          <img *ngIf="method.iconUrl" [src]="method.iconUrl" [alt]="method.displayName" />
          <i *ngIf="!method.iconUrl" [class]="getMethodTypeIcon(method)" class="method-type-icon"></i>
        </div>
        <div class="method-info">
          <h6>
            {{ method.displayName }}
            <small class="badge bg-secondary ms-2" *ngIf="method.type !== undefined">{{ getPaymentTypeLabel(method.type) }}</small>
          </h6>
          <p class="method-description" *ngIf="method.description">{{ method.description }}</p>
          <div class="method-details">
            <small class="text-muted" *ngIf="method.processingTime">
              Processing: {{ method.processingTime }}
            </small>
            <small class="text-muted" *ngIf="method.fees?.description">
              | {{ method.fees.description }}
            </small>
          </div>
        </div>
        <div class="selection-indicator">
          <i class="fas fa-check-circle" *ngIf="selectedMethod?.id === method.id"></i>
        </div>
      </div>
    </div>

    <!-- No methods available -->
    <div *ngIf="!loadingMethods && availableMethods.length === 0" class="text-center py-4">
      <i class="fas fa-info-circle text-info mb-3" style="font-size: 2rem;"></i>
      <h6>Payment method will be selected automatically</h6>
      <p class="text-muted small">The provider will handle method selection during checkout.</p>
    </div>
  </div>

  <!-- Debug Info -->
  <div class="small text-muted mb-2" style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa;">
    Step: {{ step }} | Provider: {{ selectedProvider?.displayName }} | Method: {{ selectedMethod?.displayName }} |
    CanConfirm: {{ canConfirm() }} | Loading: {{ loadingProviders || loadingMethods }}
  </div>

  <!-- Dialog Footer - moved inside dialog content -->
  <div class="dialog-footer mt-4 pt-3 border-top d-flex justify-content-end">
    <button
      type="button"
      class="btn btn-secondary me-2"
      (click)="cancel()">
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-primary"
      [disabled]="!canConfirm() || loadingProviders || loadingMethods"
      (click)="confirm()">
      <span *ngIf="step === 'provider'">Continue</span>
      <span *ngIf="step === 'method'">Proceed to Payment</span>
    </button>
  </div>
</p-dialog>
