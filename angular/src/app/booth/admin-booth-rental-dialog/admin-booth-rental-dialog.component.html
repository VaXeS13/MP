<p-dialog
  [(visible)]="visible"
  [header]="dialogTitle"
  [modal]="true"
  [style]="{width: '800px'}"
  [styleClass]="'animated-dialog'"
  [closable]="!loading"
  [closeOnEscape]="!loading"
  (onHide)="hide()">

  <div class="rental-dialog-content" *ngIf="!loadingData">

    <!-- Extension Mode Info -->
    <div *ngIf="mode === 'extend' && activeRental" class="extension-info p-3 mb-3 bg-blue-50 border-round">
      <h4 class="mt-0 mb-2 text-blue-900">Current Rental Information</h4>
      <div class="grid">
        <div class="col-6">
          <strong>User:</strong> {{ activeRental.userName }}
        </div>
        <div class="col-6">
          <strong>Current End Date:</strong> {{ activeRental.endDate | date:'yyyy-MM-dd' }}
        </div>
        <div class="col-6">
          <strong>Total Cost:</strong> {{ activeRental.totalAmount | currency:boothCurrency:'symbol':'1.2-2' }}
        </div>
        <div class="col-6">
          <strong>Status:</strong> {{ activeRental.statusDisplayName }}
        </div>
      </div>
      <p-message *ngIf="maxExtensionDate" severity="info"
        [text]="'Can extend until: ' + (maxExtensionDate | date:'yyyy-MM-dd')">
      </p-message>
    </div>

    <form [formGroup]="rentalForm" class="rental-form">

      <!-- User Selection (only for new rental) -->
      <div class="field" *ngIf="mode === 'new'">
        <label for="userId">User *</label>
        <p-select
          id="userId"
          formControlName="userId"
          [options]="availableUsers"
          optionLabel="displayName"
          optionValue="id"
          placeholder="Select User"
          [filter]="true"
          [showClear]="true"
          styleClass="w-full">
        </p-select>
        <small class="p-error" *ngIf="rentalForm.get('userId')?.invalid && rentalForm.get('userId')?.touched">
          User is required
        </small>
      </div>

      <!-- Booth Type Selection (only for new rental) -->
      <div class="field" *ngIf="mode === 'new'">
        <label for="boothTypeId">Booth Type *</label>
        <p-select
          id="boothTypeId"
          formControlName="boothTypeId"
          [options]="availableBoothTypes"
          optionLabel="name"
          optionValue="id"
          placeholder="Select Booth Type"
          [showClear]="true"
          styleClass="w-full">
        </p-select>
        <small class="p-error" *ngIf="rentalForm.get('boothTypeId')?.invalid && rentalForm.get('boothTypeId')?.touched">
          Booth type is required
        </small>
      </div>

      <!-- Calendar Date Selection -->
      <div class="field">
        <label class="mb-2">Select Rental Period *</label>
        <app-rental-calendar
          [boothId]="boothId!"
          [mode]="'admin'"
          [customMinDate]="minDate"
          [customMaxDate]="maxExtensionDate || undefined"
          [hideBoothInfo]="true"
          [hideBoothTypeSelection]="true"
          [hidePaymentActions]="true"
          [hideCalendarNavigation]="false"
          [hideLegend]="false"
          [preselectedBoothTypeId]="mode === 'new' ? rentalForm.get('boothTypeId')?.value : undefined"
          (datesSelected)="onCalendarDatesSelected($event)"
          (validationError)="onCalendarValidationError($event)"
          (costCalculated)="onCalendarCostCalculated($event)">
        </app-rental-calendar>
      </div>

      <!-- Validation Errors -->
      <p-message *ngIf="dateValidationError" severity="error" [text]="dateValidationError" styleClass="w-full mb-3"></p-message>

      <!-- Cost Summary -->
      <div class="cost-summary p-3 mb-3 bg-gray-50 border-round" *ngIf="daysCount > 0">
        <div class="grid">
          <div class="col-4">
            <strong>Days:</strong> {{ daysCount }}
          </div>
          <div class="col-4">
            <strong>Total Cost:</strong>
            <span *ngIf="!calculating">{{ totalCost | currency:boothCurrency:'symbol':'1.2-2' }}</span>
            <i *ngIf="calculating" class="pi pi-spin pi-spinner"></i>
          </div>
          <div class="col-4">
            <strong>Per Day:</strong>
            <span *ngIf="daysCount > 0">{{ (totalCost / daysCount) | currency:boothCurrency:'symbol':'1.2-2' }}</span>
          </div>
        </div>
      </div>

      <!-- Payment Methods -->
      <div class="field">
        <label>Payment Method *</label>
        <div class="payment-methods grid mt-2">
          <div class="col-6 md:col-3" *ngFor="let method of paymentMethods">
            <div
              class="payment-card p-3 border-round cursor-pointer text-center"
              [class.selected]="selectedPaymentMethod === method.value"
              (click)="rentalForm.patchValue({paymentMethod: method.value})">
              <i [class]="method.icon" class="text-4xl mb-2"></i>
              <div class="font-bold">{{ method.label }}</div>
              <small class="text-gray-600">{{ method.description }}</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Terminal Transaction Details -->
      <div *ngIf="selectedPaymentMethod === RentalPaymentMethod.Terminal" class="terminal-fields">
        <div class="field">
          <label for="terminalTransactionId">Transaction ID *</label>
          <input
            id="terminalTransactionId"
            type="text"
            pInputText
            formControlName="terminalTransactionId"
            placeholder="Enter transaction ID"
            class="w-full">
          <small class="p-error" *ngIf="rentalForm.get('terminalTransactionId')?.invalid && rentalForm.get('terminalTransactionId')?.touched">
            Transaction ID is required for terminal payment
          </small>
        </div>
        <div class="field">
          <label for="terminalReceiptNumber">Receipt Number (optional)</label>
          <input
            id="terminalReceiptNumber"
            type="text"
            pInputText
            formControlName="terminalReceiptNumber"
            placeholder="Enter receipt number"
            class="w-full">
        </div>
      </div>

      <!-- Online Payment Timeout -->
      <div *ngIf="selectedPaymentMethod === RentalPaymentMethod.Online" class="online-fields">
        <div class="field">
          <label for="onlineTimeoutMinutes">Payment Timeout (minutes) *</label>
          <p-inputNumber
            id="onlineTimeoutMinutes"
            formControlName="onlineTimeoutMinutes"
            [min]="1"
            [max]="120"
            [showButtons]="true"
            styleClass="w-full">
          </p-inputNumber>
          <small class="text-gray-600">User will have this many minutes to complete payment</small>
        </div>
      </div>

      <!-- Notes -->
      <div class="field">
        <label for="notes">Notes (optional)</label>
        <textarea
          id="notes"
          pInputTextarea
          formControlName="notes"
          rows="3"
          placeholder="Add any additional notes..."
          class="w-full">
        </textarea>
      </div>

    </form>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingData" class="loading-state p-5 text-center">
    <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
    <p class="mt-3">Loading...</p>
  </div>

  <!-- Footer -->
  <ng-template pTemplate="footer">
    <button
      pButton
      label="Cancel"
      icon="pi pi-times"
      class="p-button-text"
      (click)="hide()"
      [disabled]="loading">
    </button>
    <button
      pButton
      [label]="mode === 'extend' ? 'Extend Rental' : 'Create Rental'"
      icon="pi pi-check"
      (click)="onSubmit()"
      [disabled]="!isFormValid || loading"
      [loading]="loading">
    </button>
  </ng-template>

</p-dialog>
