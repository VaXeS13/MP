<div class="seller-checkout-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="grid">
    <div class="col-12">
      <p-card>
        <ng-template pTemplate="header">
          <div class="p-3">
            <h2 class="m-0">Seller Checkout</h2>
            <p class="text-600 m-0">Scan barcode or enter manually to find items</p>
          </div>
        </ng-template>

        <!-- Barcode Scanner Input -->
        <div class="field">
          <label for="barcode">Barcode</label>
          <div class="p-inputgroup">
            <span class="p-inputgroup-addon">
              <i class="pi pi-qrcode"></i>
            </span>
            <input
              id="barcode"
              type="text"
              pInputText
              [(ngModel)]="barcode"
              (keydown)="onBarcodeInput($event)"
              placeholder="Scan or enter barcode"
              [disabled]="isLoading || isProcessing"
              autofocus
            />
            <button
              pButton
              type="button"
              (click)="findItem()"
              [disabled]="!barcode.trim() || isLoading || isProcessing"
            >
              <i class="pi pi-search" *ngIf="!isLoading"></i>
              <i *ngIf="isLoading" class="pi pi-spin pi-spinner"></i>
              <span class="ml-2">Find</span>
            </button>
          </div>
        </div>

        <!-- Loading Spinner -->
        <div *ngIf="isLoading" class="flex justify-content-center my-4">
          <p-progressSpinner></p-progressSpinner>
        </div>

        <!-- Scanned Items Table -->
        <div *ngIf="scannedItems.length > 0 && !isLoading" class="mt-4">
          <p-card>
            <ng-template pTemplate="header">
              <div class="flex justify-content-between align-items-center p-3">
                <h3 class="m-0">Zeskanowane przedmioty ({{ scannedItems.length }})</h3>
                <button
                  pButton
                  type="button"
                  icon="pi pi-times"
                  class="p-button-rounded p-button-text"
                  (click)="clearAll()"
                  title="Wyczyść wszystko"
                ></button>
              </div>
            </ng-template>

            <!-- Items Table -->
            <div class="table-responsive">
              <table class="p-datatable-table">
                <thead>
                  <tr>
                    <th>Nazwa</th>
                    <th>Kategoria</th>
                    <th>Klient</th>
                    <th>Cena</th>
                    <th>Prowizja</th>
                    <th>Netto</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of scannedItems">
                    <td>
                      <div class="flex align-items-center">
                        <i class="pi pi-box mr-2"></i>
                        <span>{{ item.name }}</span>
                      </div>
                    </td>
                    <td>{{ item.category || 'Brak' }}</td>
                    <td>
                      <small>
                        {{ item.customerName }}
                        <span *ngIf="item.customerEmail" class="text-600">({{ item.customerEmail }})</span>
                      </small>
                    </td>
                    <td class="text-right">
                      <strong>{{ (item.actualPrice || 0).toFixed(2) }} PLN</strong>
                    </td>
                    <td class="text-right">
                      <span class="text-orange-600">{{ (item.commissionAmount || 0).toFixed(2) }} PLN</span>
                      <small class="block text-600">({{ item.commissionPercentage }}%)</small>
                    </td>
                    <td class="text-right">
                      <span class="text-green-600 font-semibold">{{ (item.customerAmount || 0).toFixed(2) }} PLN</span>
                    </td>
                    <td>
                      <button
                        pButton
                        type="button"
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-text p-button-danger"
                        (click)="removeItem(item.id)"
                        title="Usuń przedmiot"
                      ></button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Summary Section -->
            <ng-template pTemplate="footer">
              <div class="border-top-1 surface-border pt-3">
                <div class="grid">
                  <div class="col-12 md:col-6">
                    <div class="flex justify-content-between">
                      <span class="text-600">Liczba przedmiotów:</span>
                      <span class="font-bold">{{ checkoutSummary?.itemsCount || 0 }}</span>
                    </div>
                    <div class="flex justify-content-between mt-2">
                      <span class="text-600">Suma prowizji:</span>
                      <span class="font-bold text-orange-600">{{ (checkoutSummary?.totalCommission || 0).toFixed(2) }} PLN</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6 text-right">
                    <div class="mb-2">
                      <span class="text-600 mr-2">Suma całkowita:</span>
                      <span class="text-2xl font-bold text-primary">{{ (checkoutSummary?.totalAmount || 0).toFixed(2) }} PLN</span>
                    </div>
                    <button
                      pButton
                      type="button"
                      class="p-button-success p-button-lg"
                      (click)="showPaymentConfirmation()"
                      [disabled]="isProcessing"
                    >
                      <i class="pi pi-credit-card mr-2" *ngIf="!isProcessing"></i>
                      <i *ngIf="isProcessing" class="pi pi-spin pi-spinner mr-2"></i>
                      <span>Zapłać</span>
                    </button>
                  </div>
                </div>
              </div>
            </ng-template>
          </p-card>
        </div>

        <!-- Empty State -->
        <div *ngIf="scannedItems.length === 0 && !isLoading" class="mt-4 text-center">
          <p-message
            severity="info"
            text="Zeskanuj kod kreskowy, aby dodać przedmioty do sprzedaży"
          ></p-message>
        </div>

        <!-- Terminal Status -->
        <div *ngIf="availablePaymentMethods?.cardEnabled" class="mt-3">
          <p-message
            severity="info"
            [text]="'Terminal: ' + (availablePaymentMethods?.terminalProviderName || 'Unknown')"
          ></p-message>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Payment Method Selection Dialog -->
  <p-dialog
    [(visible)]="showPaymentDialog"
    [modal]="true"
    [closable]="true"
    [showHeader]="true"
    [header]="'Wybierz metodę płatności'"
    (onHide)="hidePaymentDialog()"
    [style]="{ width: '350px' }"
  >
    <div class="payment-methods-dialog">
      <div class="text-center mb-4">
        <h3 class="m-0">Do zapłaty: {{ (checkoutSummary?.totalAmount || 0).toFixed(2) }} PLN</h3>
        <small class="text-600">{{ checkoutSummary?.itemsCount || 0 }} przedmiot(ów)</small>
      </div>

      <button
        pButton
        type="button"
        class="w-full p-button-lg mb-3"
        icon="pi pi-money-bill"
        label="💵 Gotówka"
        (click)="checkout(PaymentMethodType.Cash)"
        [disabled]="isProcessing"
      ></button>

      <button
        pButton
        type="button"
        class="w-full p-button-lg p-button-success"
        icon="pi pi-credit-card"
        [label]="'💳 Karta'"
        (click)="checkout(PaymentMethodType.Card)"
        [disabled]="!availablePaymentMethods?.cardEnabled || isProcessing"
      >
        <ng-template #tooltipContent *ngIf="!availablePaymentMethods?.cardEnabled">
          Terminal jest niedostępny
        </ng-template>
      </button>

      <small *ngIf="availablePaymentMethods?.cardEnabled" class="block text-center mt-3 text-600">
        Terminal: {{ availablePaymentMethods?.terminalProviderName }}
      </small>
      <small *ngIf="!availablePaymentMethods?.cardEnabled" class="block text-center mt-3 text-red-600">
        ⚠️ Terminal niedostępny - tylko gotówka
      </small>
    </div>
  </p-dialog>
</div>