<div class="notification-center">
  <!-- Header with stats -->
  <div class="notification-header surface-border border-bottom-1 p-4">
    <div class="flex justify-content-between align-items-center mb-3">
      <h3 class="m-0 text-xl font-semibold">Centrum Powiadomień</h3>
      <button
        pButton
        type="button"
        icon="pi pi-refresh"
        [loading]="loading"
        (click)="refreshCurrentTab()"
        pTooltip="Odśwież"
        tooltipPosition="bottom"
        class="p-button-rounded p-button-text p-button-secondary">
      </button>
    </div>

    <!-- Stats row -->
    <div class="notification-stats grid grid-nogutter">
      <div class="col-12 md:col-3 text-center mb-2 md:mb-0">
        <div class="text-2xl font-bold text-primary">{{ stats.unreadCount }}</div>
        <div class="text-sm text-color-secondary">Nieprzeczytane</div>
      </div>
      <div class="col-12 md:col-3 text-center mb-2 md:mb-0">
        <div class="text-2xl font-bold">{{ stats.totalCount }}</div>
        <div class="text-sm text-color-secondary">Wszystkie</div>
      </div>
      <div class="col-12 md:col-3 text-center mb-2 md:mb-0">
        <div class="text-2xl font-bold text-green-500">{{ stats.readCount }}</div>
        <div class="text-sm text-color-secondary">Przeczytane</div>
      </div>
      <div class="col-12 md:col-3 text-center">
        <div class="text-2xl font-bold text-orange-500">{{ stats.expiredCount }}</div>
        <div class="text-sm text-color-secondary">Wygasłe</div>
      </div>
    </div>
  </div>

  <!-- Search and filters -->
  <div class="notification-filters surface-border border-bottom-1 p-3">
    <div class="flex flex-wrap gap-3 align-items-center">
      <!-- Search input -->
      <div class="flex-1" style="min-width: 200px;">
        <span class="p-input-icon-left w-full">
          <i class="pi pi-search"></i>
          <input
            #searchInput
            pInputText
            type="text"
            placeholder="Szukaj powiadomień..."
            class="w-full"
            (input)="onSearch($event)"
            [value]="searchTerm">
        </span>
      </div>

      <!-- Severity filter -->
      <div style="min-width: 150px;">
        <p-dropdown
          [options]="severityOptions"
          [(ngModel)]="selectedSeverity"
          optionLabel="label"
          optionValue="value"
          placeholder="Filtruj priorytet"
          class="w-full"
          (onChange)="onSeverityChange()">
        </p-dropdown>
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2 flex-wrap">
        <button
          pButton
          label="Oznacz jako przeczytane"
          [disabled]="!hasSelection"
          icon="pi pi-check"
          size="small"
          (click)="markSelectedAsRead()">
        </button>
        <button
          pButton
          label="Oznacz wszystkie jako przeczytane"
          [disabled]="!hasUnreadInCurrentView"
          icon="pi pi-check-double"
          size="small"
          severity="secondary"
          (click)="markAllAsRead()">
        </button>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div class="p-4" *ngIf="loading">
    <p-progressBar mode="indeterminate" [style]="{'height': '4px'}"></p-progressBar>
  </div>

  <!-- Tabs for unread/all notifications -->
  <div class="notification-content">
    <p-tabView [(activeIndex)]="activeTabIndex" (onChange)="onTabChange($event)">
      <!-- Unread notifications tab -->
      <p-tabPanel header="Nieprzeczytane" leftIcon="pi pi-envelope">
        <div class="notification-list">
          <ng-container *ngIf="currentNotifications.length > 0; else noUnreadNotifications">
            <div
              *ngFor="let notification of currentNotifications; trackBy: trackByNotificationId"
              class="notification-item p-3 border-bottom-1 surface-border cursor-pointer hover:surface-hover"
              [class.unread]="!notification.isRead"
              (click)="onNotificationClick(notification)">

              <div class="flex align-items-start gap-3">
                <!-- Checkbox for selection -->
                <div class="flex align-items-center pt-1">
                  <p-checkbox
                    [binary]="true"
                    [checked]="selectedNotifications.includes(notification.id)"
                    (onChange)="onNotificationSelect(notification.id, $event)"
                    (click)="$event.stopPropagation()">
                  </p-checkbox>
                </div>

                <!-- Severity icon -->
                <div class="flex align-items-center pt-1">
                  <i [class]="getSeverityIcon(notification.severity)"
                     [class]="getSeverityClass(notification.severity)"
                     class="text-xl"></i>
                </div>

                <!-- Notification content -->
                <div class="flex-1 min-w-0">
                  <div class="flex justify-content-between align-items-start gap-2">
                    <h4 class="m-0 font-semibold text-overflow-ellipsis white-space-nowrap overflow-hidden flex-1"
                        [class.text-primary]="!notification.isRead">
                      {{ notification.title }}
                    </h4>
                    <div class="flex gap-2 flex-shrink-0">
                      <!-- Delete button -->
                      <button
                        pButton
                        icon="pi pi-trash"
                        [text]="true"
                        [rounded]="true"
                        size="small"
                        severity="danger"
                        (click)="deleteNotification(notification.id); $event.stopPropagation()"
                        pTooltip="Usuń">
                      </button>
                    </div>
                  </div>

                  <p class="m-0 mt-1 text-sm text-color-secondary line-height-3">
                    {{ notification.message }}
                  </p>

                  <div class="flex justify-content-between align-items-center mt-2">
                    <div class="flex gap-3 text-xs text-color-secondary">
                      <span>{{ formatDate(notification.creationTime) }}</span>
                      <span *ngIf="notification.type" class="text-capitalize">{{ notification.type }}</span>
                    </div>
                    <span *ngIf="!notification.isRead" class="unread-indicator">
                      <p-badge value="Nowe" severity="info"></p-badge>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- No unread notifications template -->
          <ng-template #noUnreadNotifications>
            <div class="text-center p-6 text-color-secondary">
              <i class="pi pi-check-circle text-5xl mb-3 text-green-500"></i>
              <h4 class="m-0 mb-2">Brak nieprzeczytanych powiadomień</h4>
              <p class="m-0">Wszystkie powiadomienia zostały przeczytane</p>
            </div>
          </ng-template>
        </div>

        <!-- Pagination for unread -->
        <div class="p-3 border-top-1 surface-border" *ngIf="unreadTotalCount > pageSize">
          <p-paginator
            [rows]="pageSize"
            [totalRecords]="unreadTotalCount"
            [first]="currentPage * pageSize"
            [rowsPerPageOptions]="[10, 20, 50]"
            (onPageChange)="onPageChange($event)"
            pageLinkSize="3">
          </p-paginator>
        </div>
      </p-tabPanel>

      <!-- All notifications tab -->
      <p-tabPanel header="Wszystkie" leftIcon="pi pi-list">
        <div class="notification-list">
          <ng-container *ngIf="currentNotifications.length > 0; else noAllNotifications">
            <div
              *ngFor="let notification of currentNotifications; trackBy: trackByNotificationId"
              class="notification-item p-3 border-bottom-1 surface-border cursor-pointer hover:surface-hover"
              [class.read]="notification.isRead"
              (click)="onNotificationClick(notification)">

              <div class="flex align-items-start gap-3">
                <!-- Checkbox for selection -->
                <div class="flex align-items-center pt-1">
                  <p-checkbox
                    [binary]="true"
                    [checked]="selectedNotifications.includes(notification.id)"
                    (onChange)="onNotificationSelect(notification.id, $event)"
                    (click)="$event.stopPropagation()">
                  </p-checkbox>
                </div>

                <!-- Severity icon -->
                <div class="flex align-items-center pt-1">
                  <i [class]="getSeverityIcon(notification.severity)"
                     [class]="getSeverityClass(notification.severity)"
                     class="text-xl"></i>
                </div>

                <!-- Notification content -->
                <div class="flex-1 min-w-0">
                  <div class="flex justify-content-between align-items-start gap-2">
                    <h4 class="m-0 font-semibold text-overflow-ellipsis white-space-nowrap overflow-hidden flex-1"
                        [class.text-color-secondary]="notification.isRead">
                      {{ notification.title }}
                    </h4>
                    <div class="flex gap-2 flex-shrink-0">
                      <!-- Delete button -->
                      <button
                        pButton
                        icon="pi pi-trash"
                        [text]="true"
                        [rounded]="true"
                        size="small"
                        severity="danger"
                        (click)="deleteNotification(notification.id); $event.stopPropagation()"
                        pTooltip="Usuń">
                      </button>
                    </div>
                  </div>

                  <p class="m-0 mt-1 text-sm text-color-secondary line-height-3">
                    {{ notification.message }}
                  </p>

                  <div class="flex justify-content-between align-items-center mt-2">
                    <div class="flex gap-3 text-xs text-color-secondary">
                      <span>{{ formatDate(notification.creationTime) }}</span>
                      <span *ngIf="notification.readAt">Przeczytane: {{ formatDate(notification.readAt) }}</span>
                      <span *ngIf="notification.type" class="text-capitalize">{{ notification.type }}</span>
                    </div>
                    <span *ngIf="notification.isRead" class="read-indicator">
                      <i class="pi pi-check text-green-500"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- No notifications template -->
          <ng-template #noAllNotifications>
            <div class="text-center p-6 text-color-secondary">
              <i class="pi pi-inbox text-5xl mb-3"></i>
              <h4 class="m-0 mb-2">Brak powiadomień</h4>
              <p class="m-0">Nie masz żadnych powiadomień</p>
            </div>
          </ng-template>
        </div>

        <!-- Pagination for all notifications -->
        <div class="p-3 border-top-1 surface-border" *ngIf="allTotalCount > pageSize">
          <p-paginator
            [rows]="pageSize"
            [totalRecords]="allTotalCount"
            [first]="currentPage * pageSize"
            [rowsPerPageOptions]="[10, 20, 50]"
            (onPageChange)="onPageChange($event)"
            pageLinkSize="3">
          </p-paginator>
        </div>
      </p-tabPanel>
    </p-tabView>
  </div>
</div>