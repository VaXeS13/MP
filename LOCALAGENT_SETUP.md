# LocalAgent Setup & Configuration Guide

Instrukcja instalacji i konfiguracji MP.LocalAgent na komputerze kasiera z integracjƒÖ kasy fiskalnej, terminala p≈Çatniczego i API.

## üìã Spis Tre≈õci

1. [Wymagania](#wymagania)
2. [Instalacja Agenta](#instalacja-agenta)
3. [Rejestracja w API](#rejestracja-w-api)
4. [Konfiguracja Agenta](#konfiguracja-agenta)
5. [Konfiguracja UrzƒÖdze≈Ñ](#konfiguracja-urzƒÖdze≈Ñ)
6. [Testowanie Integracji](#testowanie-integracji)
7. [Troubleshooting](#troubleshooting)

---

## Wymagania

### System Operacyjny
- Windows 10/11 lub Windows Server 2016+
- Administrator account dla instalacji jako Windows Service
- .NET 9.0 Runtime lub Runtime Hosting Bundle

### Sprzƒôt
- **Terminal P≈Çatniczy**: np. Ingenico, PAX, Verifone (obs≈Çugiwane przez API producenta)
- **Kasa Fiskalna**: Niezbƒôdna dla Polski - obs≈Çugiwana przez LocalAgent
- **Sieƒá**: Po≈ÇƒÖczenie internetowe do Azure API (stabilne, IP statyczne rekomendowane)

### Oprogramowanie
- .NET 9.0 Runtime: https://dotnet.microsoft.com/download/dotnet/9.0
- (Opcjonalnie) Visual Studio Code lub Notepad++ do edycji JSON

---

## Instalacja Agenta

### Krok 1: Pobranie Plik√≥w Agenta

```bash
# Na komputerze kasiera (w folderu C:\MP\LocalAgent)
cd C:\MP
# Pobierz release build - bƒôdzie to C:\MP\LocalAgent\bin\Release\net9.0\

# Lub zbuduj samodzielnie:
cd C:\Users\vaxes\source\repos\MP\MP
dotnet publish src/MP.LocalAgent/MP.LocalAgent.csproj -c Release -o C:\MP\LocalAgent\Release
```

**Struktura folder√≥w po budowie:**
```
C:\MP\LocalAgent\Release\
‚îú‚îÄ‚îÄ MP.LocalAgent.exe
‚îú‚îÄ‚îÄ appsettings.json
‚îú‚îÄ‚îÄ appsettings.Production.json (je≈õli istnieje)
‚îú‚îÄ‚îÄ MP.LocalAgent.dll
‚îú‚îÄ‚îÄ *.deps.json
‚îî‚îÄ‚îÄ Logs/
```

### Krok 2: Weryfikacja .NET 9.0

```bash
# W PowerShell (jako Administrator)
dotnet --version
# Powinien pokazaƒá: 9.0.x lub wy≈ºej

# Je≈õli brakuje, zainstaluj:
# Pobierz z: https://dotnet.microsoft.com/download/dotnet/9.0
# Wybierz: .NET Runtime lub .NET Hosting Bundle (lepiej dla Windows Service)
```

### Krok 3: Test Uruchomienia (Console Mode)

```bash
# Na komputerze kasiera
cd C:\MP\LocalAgent\Release

# Uruchom w konsoli aby sprawdziƒá konfiguracjƒô
.\MP.LocalAgent.exe

# Powinno pojawiƒá siƒô:
# [INF] Starting MP Local Agent...
# [INF] Initializing MP Local Agent services...
# [INF] Offline command store initialized
# [INF] MP Local Agent services initialized successfully

# Aby zatrzymaƒá: Ctrl+C
```

Je≈õli widaƒá b≈Çƒôdy - sprawd≈∫ sekcjƒô [Troubleshooting](#troubleshooting).

---

## Rejestracja w API

### Krok 1: Login do Systemu MP (Azure)

1. Otw√≥rz https://localhost:44377 (lub productiondomain.com)
2. Login jako Administrator
3. Przejd≈∫ do **Settings** ‚Üí **Agent Management** (lub podobnie)

### Krok 2: Rejestracja Nowego Agenta

W Admin Panel:

1. **Agent Name**: `DEVICE_NAME_KASIER_1` (np. `KASA_WARSZAWA_01`)
2. **Agent Type**: `LocalAgent` lub `CashierTerminal`
3. **Location**: Warszawa (lub lokalizacja faktyczna)
4. **Device Type**:
   - ‚úÖ Terminal P≈Çatniczy
   - ‚úÖ Kasa Fiskalna
   - ‚úÖ Barcode Scanner (opcjonalnie)

**Kliknij: Register Agent**

Otrzymasz:
- **Agent ID**: np. `550e8400-e29b-41d4-a716-446655440000`
- **Tenant ID**: np. `550e8400-e29b-41d4-a716-446655440001`

### Krok 3: Generowanie API Key

W Agent Management:

1. Kliknij na zarejestrowanego agenta
2. **Security** sekcja
3. **Generate New API Key**

Otrzymasz:
```
API Key Prefix: MPA_DEVICE_1234_
API Key (SECRET - skopiuj teraz!): MPA_DEVICE_1234_abcdef1234567890abcdef1234567890
```

‚ö†Ô∏è **WA≈ªNE**: Skopiuj pe≈Çny klucz! Nastƒôpnym razem nie bƒôdzie widoczny!

### Krok 4: IP Whitelisting (bezpiecze≈Ñstwo)

Opcjonalnie w Agent Security:

1. **IP Whitelist** ‚Üí Add IP
2. Wpisz IP komputera kasiera (np. `192.168.1.100` lub `*` dla testu)
3. **Save**

---

## Konfiguracja Agenta

### Krok 1: Edytuj `appsettings.json`

Na komputerze kasiera (`C:\MP\LocalAgent\Release\appsettings.json`):

```json
{
  "Serilog": {
    "MinimumLevel": "Information",
    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "File",
        "Args": {
          "path": "Logs/localagent-.txt",
          "rollingInterval": "Day"
        }
      }
    ]
  },
  "LocalAgent": {
    "TenantId": "550e8400-e29b-41d4-a716-446655440001",
    "AgentId": "550e8400-e29b-41d4-a716-446655440000",
    "ServerUrl": "https://localhost:44377",
    "ApiKey": "MPA_DEVICE_1234_abcdef1234567890abcdef1234567890",
    "HeartbeatIntervalSeconds": 30,
    "ReconnectTimeoutSeconds": 120,
    "MaxCommandQueueSize": 10000
  },
  "Devices": {
    "Terminal": {
      "ProviderId": "mock",
      "Enabled": true,
      "ConnectionString": "COM3",
      "BaudRate": 9600,
      "Model": "Ingenico_iCT250",
      "Timeout": 30
    },
    "FiscalPrinter": {
      "ProviderId": "mock",
      "Enabled": true,
      "ConnectionString": "\\\\\\\\192.168.1.10\\\\LPR1",
      "Model": "Posnet_Thermal_FV",
      "Timeout": 20
    },
    "BarcodeScanner": {
      "ProviderId": "mock",
      "Enabled": true,
      "ConnectionString": "COM4",
      "BaudRate": 9600
    }
  }
}
```

### Krok 2: Wyja≈õnienie Konfiguracji

| Pole | Warto≈õƒá | Opis |
|------|---------|------|
| `TenantId` | GUID z kroku 2.1 | ID dzier≈ºawcy (np. Warszawa) |
| `AgentId` | GUID z kroku 2.1 | Unikalny ID agenta |
| `ServerUrl` | URL API | `https://localhost:44377` (dev) lub domena produkcyjna |
| `ApiKey` | Klucz z kroku 2.3 | Uwierzytelnienie wobec API |
| `HeartbeatIntervalSeconds` | 30 | Jak czƒôsto wysy≈Çaƒá heartbeat do API |
| `ReconnectTimeoutSeconds` | 120 | Timeout dla reconnect (2 min) |

### Krok 3: Konfiguracja Terminala

W sekcji `Terminal`:

```json
"Terminal": {
  "ProviderId": "real_device",  // zmie≈Ñ z "mock" na rzeczywisty provider
  "Enabled": true,
  "Model": "INGENICO_iCT250",
  "ConnectionString": "COM3",   // Port COM terminala
  "BaudRate": 9600,
  "Timeout": 30
}
```

**Dla R√≥≈ºnych Terminali:**

- **Ingenico iCT250**:
  ```
  "ConnectionString": "COM3"
  "BaudRate": 9600
  ```

- **PAX A80**:
  ```
  "ConnectionString": "COM4"
  "BaudRate": 115200
  ```

- **Verifone Omni 3750**:
  ```
  "ConnectionString": "192.168.1.50:7001"  // IP:Port
  "Protocol": "TCP"
  ```

### Krok 4: Konfiguracja Kasy Fiskalnej

W sekcji `FiscalPrinter`:

```json
"FiscalPrinter": {
  "ProviderId": "real_device",
  "Enabled": true,
  "Model": "POSNET_THERMAL_FV",
  "ConnectionString": "\\\\192.168.1.10\\Drukarka_Fiskalna",
  "Timeout": 20
}
```

**Dla R√≥≈ºnych Kas:**

- **Posnet Thermal FV** (sieciowa):
  ```
  "ConnectionString": "\\\\192.168.1.10\\LPR1"
  ```

- **Elzab Mera** (seria COM):
  ```
  "ConnectionString": "COM5"
  "BaudRate": 19200
  ```

- **Novitus Ma≈Ça Gwiazda** (USB):
  ```
  "ConnectionString": "USB_DEVICE_ID"
  ```

### Krok 5: Test Konfiguracji

Uruchom agenta w trybie testowym:

```bash
cd C:\MP\LocalAgent\Release

# Ustaw env do test√≥w
$env:DOTNET_ENVIRONMENT = "Development"

# Uruchom
.\MP.LocalAgent.exe

# Sprawd≈∫ w logach (Logs/localagent-YYYY-MM-DD.txt):
# [INF] Initializing fiscal printer with provider mock
# [INF] Initializing terminal with provider mock
# [INF] Connecting to SignalR hub at https://localhost:44377
```

---

## Konfiguracja UrzƒÖdze≈Ñ

### Krok 1: Fizyczne Pod≈ÇƒÖczenie Terminala

1. **UrzƒÖdzenie**: Po≈ÇƒÖcz terminal do komputera kasiera przez:
   - **Port COM** (serial): Kabel RS-232
   - **USB**: Adapter USB-Serial
   - **Ethernet**: Port sieciowy z IP statycznym

2. **Weryfikacja Portu**:
   ```bash
   # W PowerShell
   Get-WmiObject Win32_SerialPort | Select Name, Description
   # Powinno pokazaƒá np: COM3 - USB Serial Port
   ```

3. **Ustawienia Terminala** (na urzƒÖdzeniu):
   - Baud Rate: 9600 lub 115200 (sprawd≈∫ manual)
   - Data Bits: 8
   - Stop Bits: 1
   - Parity: None

### Krok 2: Fizyczne Pod≈ÇƒÖczenie Kasy Fiskalnej

1. **UrzƒÖdzenie**: Po≈ÇƒÖcz kasƒô do:
   - **Sieci (LPR)**: IP-adres kasy + port (domy≈õlnie 9100)
   - **Port COM**: Kabel RS-232
   - **USB**: Adapter USB-Serial

2. **Znalezienie IP Kasy**:
   ```bash
   # W PowerShell
   arp -a
   # Poszukaj wpisu Posnet/Elzab/Novitus

   # Lub sprawd≈∫ w ustawieniach kasy (Menu ‚Üí Sieƒá ‚Üí Status)
   ```

3. **Test Po≈ÇƒÖczenia do Kasy (sieciowej)**:
   ```bash
   ping 192.168.1.10
   # Powinno: Reply from 192.168.1.10: bytes=32 time=5ms TTL=64
   ```

### Krok 3: Rejestracja UrzƒÖdze≈Ñ w API

W Admin Panel ‚Üí Agent Management ‚Üí Agent Details:

1. **Terminal**:
   - Status: `Online` / `Offline`
   - Model: `INGENICO_iCT250`
   - Serial: (automatycznie pobrane z urzƒÖdzenia)
   - Firmware: (automatycznie pobrane)

2. **Kasa Fiskalna**:
   - Status: `Online` / `Offline`
   - Model: `POSNET_THERMAL_FV`
   - Serial: (automatycznie pobrane)
   - Last Z-Report: (bie≈ºƒÖca data)

### Krok 4: Konfiguracja Obs≈Çugi UrzƒÖdze≈Ñ

W sekcji `MP.Application/ItemCheckoutAppService.cs`:

UrzƒÖdzenia sƒÖ ju≈º skonfigurowane do automatycznego u≈ºytku poprzez `IRemoteDeviceProxy`:

```csharp
// Nie musisz nic robiƒá - jest automatyczne!
// Proxy bƒôdzie automatycznie:
// 1. Autoryzowaƒá p≈Çatno≈õƒá na terminalu
// 2. Drukowaƒá paragon na kasie
// 3. ≈öledziƒá transakcje w CRK
```

---

## Testowanie Integracji

### Test 1: Weryfikacja Po≈ÇƒÖczenia SignalR

1. Uruchom agenta:
   ```bash
   cd C:\MP\LocalAgent\Release
   .\MP.LocalAgent.exe
   ```

2. W logach powinno byƒá:
   ```
   [INF] Connecting to SignalR hub at https://localhost:44377
   [INF] Connected to Azure API
   [INF] Agent registered: 550e8400-e29b-41d4-a716-446655440000
   ```

3. Je≈õli brak lub b≈ÇƒÖd - sprawd≈∫:
   - Czy API jest uruchomiony: `https://localhost:44377/health-status`
   - Czy API Key jest poprawny
   - Czy IP agenta jest na whitelist

### Test 2: Weryfikacja Terminala

W Admin Panel ‚Üí Device Status:

```
Terminal: INGENICO_iCT250
Status: ‚úÖ Online
Last Heartbeat: 30s ago
Capabilities: [VISA, Mastercard, Contactless, EMV, 3D-Secure]
```

Lub test rƒôczny:
```bash
# W PowerShell na komputerze kasiera
# Wysy≈Çaj test do terminala

# Terminal powinien odpowiedzieƒá: "READY" lub "OK"
```

### Test 3: Weryfikacja Kasy Fiskalnej

W Admin Panel ‚Üí Device Status:

```
Fiscal Printer: POSNET_THERMAL_FV
Status: ‚úÖ Online
Last Receipt: 2024-10-23 14:32:00
Total Receipts Today: 45
Paper Status: ‚úÖ OK
Fiscal Memory: 23% used
```

Test rƒôczny:
```bash
# Wydrukuj test receipt z API
POST https://localhost:44377/api/app/fiscal/test-receipt
Content-Type: application/json

{
  "agentId": "550e8400-e29b-41d4-a716-446655440000",
  "amount": 100.00,
  "description": "Test Receipt"
}

# Kasa powinna wydrukowaƒá paragon testowy
```

### Test 4: Integracja Pe≈Çnego Przep≈Çywu Sprzeda≈ºowego

1. **Otw√≥rz punkt sprzeda≈ºy** (ng serve lub production)
2. **Dodaj buty do koszyka**
3. **Przejd≈∫ do kasy**
4. **Wybierz p≈Çatno≈õƒá kartƒÖ**
5. **System:**
   - ‚úÖ Wy≈õle ≈ºƒÖdanie do Terminala
   - ‚úÖ Terminal za≈ºƒÖda karty
   - ‚úÖ Zarejestruje autoryzacjƒô
   - ‚úÖ Wydrukuje paragon na kasie
   - ‚úÖ Zarejestruje w CRK
   - ‚úÖ Poka≈ºƒô potwierdzenie

```json
// Spodziewana odpowied≈∫
{
  "status": "SUCCESS",
  "transactionId": "TRX_20241023_001",
  "terminalId": "INGENICO_iCT250",
  "amount": 250.50,
  "currency": "PLN",
  "receiptNumber": "00001234",
  "timestamp": "2024-10-23T14:35:22.123Z",
  "crk_registered": true,
  "masked_pan": "****1234"
}
```

### Test 5: Offline Mode

1. **Roz≈ÇƒÖcz Internet** (lub wy≈ÇƒÖcz API)
2. **Wykonaj p≈Çatno≈õƒá**
3. System powinien:
   - ‚úÖ Pokazaƒá "Offline Mode"
   - ‚úÖ Zapisaƒá komendƒô do SQLite
   - ‚úÖ Wys≈Çaƒá po powrocie do sieci

Sprawdzenie SQLite:
```bash
# Na komputerze kasiera
cd C:\Users\[User]\AppData\Local\MP\LocalAgent

# Lista offline komend
sqlite3 commands.db
> SELECT CommandId, Status FROM OfflineCommands LIMIT 5;
```

---

## Troubleshooting

### Problem 1: Agent nie ≈ÇƒÖczy siƒô do API

**Symptomy**:
```
[ERR] Failed to connect to SignalR hub
[ERR] Connection timeout after 120 seconds
```

**RozwiƒÖzanie**:
```bash
# 1. Sprawd≈∫ czy API jest dostƒôpny
curl https://localhost:44377/health-status
# Powinien zwr√≥ciƒá 200 OK

# 2. Sprawd≈∫ czy Agent.ApiKey jest poprawny
# W appsettings.json por√≥wnaj z API Panel

# 3. Sprawd≈∫ firewall
# Port 44377 musi byƒá dostƒôpny (lub port produkcyjny)

# 4. Sprawd≈∫ DNS (je≈õli domena)
nslookup api.yourdomain.com
```

### Problem 2: Terminal offline

**Symptomy**:
```
[WRN] Terminal status: OFFLINE
[ERR] Payment command timeout after 30 seconds
```

**RozwiƒÖzanie**:
```bash
# 1. Sprawd≈∫ fizyczne po≈ÇƒÖczenie
# - Czy kabel COM/USB jest pod≈ÇƒÖczony?
# - Czy port w Deviceu Manager pokazuje COM3/COM4?

# 2. Sprawd≈∫ port w appsettings.json
"ConnectionString": "COM3"  # czy to prawid≈Çowy port?

# 3. Test po≈ÇƒÖczenia z terminalem
# W PowerShell
$port = New-Object System.IO.Ports.SerialPort COM3
$port.Open()
$port.WriteLine("AT")  # test polecenia
$port.Close()

# 4. Sprawd≈∫ baud rate (domy≈õlnie 9600)
# W manual terminala
```

### Problem 3: Kasa nie drukuje

**Symptomy**:
```
[ERR] Fiscal printer error: OFFLINE
[ERR] Paper out or printer not ready
```

**RozwiƒÖzanie**:
```bash
# 1. Sprawd≈∫ papier w kasie
# Otw√≥rz kase i za≈Çaduj papier

# 2. Sprawd≈∫ po≈ÇƒÖczenie sieciowe (je≈õli sieciowa)
ping 192.168.1.10
# Powinien zwr√≥ciƒá odpowied≈∫

# 3. Sprawd≈∫ status kasy
# Na ekranie kasy: Menu ‚Üí Status
# Powinno pokazywaƒá: "Ready" lub "Online"

# 4. Test manualny
# Z interfejsu kasy: Print Test Receipt
```

### Problem 4: API Key rejected

**Symptomy**:
```
[ERR] Authentication failed: Invalid API Key
[ERR] Code 401: Unauthorized
```

**RozwiƒÖzanie**:
```bash
# 1. Sprawd≈∫ czy API Key jest wklejony poprawnie
# W appsettings.json - nie mo≈ºe byƒá: spacji, z≈Çamania linii

# 2. Sprawd≈∫ czy jest aktywny w API Panel
# Agent Management ‚Üí Security ‚Üí API Keys
# Status powinien byƒá: ‚úÖ Active

# 3. Sprawd≈∫ czy nie jest wygas≈Çy
# Expiration Date powinien byƒá w przysz≈Ço≈õci

# 4. Sprawd≈∫ IP Whitelist
# Je≈õli ustawiony - IP komputera musi byƒá na li≈õcie
```

### Problem 5: SQLite database locked

**Symptomy**:
```
[ERR] SQLite database is locked
[ERR] Offline commands cannot be saved
```

**RozwiƒÖzanie**:
```bash
# 1. Sprawd≈∫ czy agent jest uruchomiony 2x
# W Task Manager: Powinno byƒá 1x MP.LocalAgent.exe

# 2. Zrestartuj agenta
# Ctrl+C w konsoli
# Czekaj 5 sekund
# Uruchom ponownie

# 3. Usu≈Ñ lock file (je≈õli istnieje)
cd C:\Users\[User]\AppData\Local\MP\LocalAgent
# Szukaj: commands.db-shm, commands.db-wal
# Usu≈Ñ je i zrestartuj
```

### Problem 6: Dysk pe≈Çny - zbyt wiele offline komend

**Symptomy**:
```
[ERR] Queue size exceeded: 10000/10000 commands
[ERR] Cannot save new commands
```

**RozwiƒÖzanie**:
```bash
# 1. Sprawd≈∫ czy API jest dostƒôpny
# Agent powinien wys≈Çaƒá offline komendy

# 2. Wyczy≈õƒá stare komendy (>7 dni)
# Agent robi to automatycznie co 5 minut
# Ale mo≈ºesz rƒôcznie:

sqlite3 commands.db
> DELETE FROM OfflineCommands WHERE CreatedAt < datetime('now', '-7 days');
> VACUUM;
> .quit

# 3. Zrestartuj agenta
```

---

## Instalacja jako Windows Service

Po testowaniu w konsoli, zainstaluj jako Windows Service:

```bash
# W PowerShell (jako Administrator)

# 1. Zatrzymaj proces je≈õli jest uruchomiony
Stop-Process -Name "MP.LocalAgent" -Force

# 2. Instalacja jako service
$ServiceName = "MPLocalAgent"
$ServicePath = "C:\MP\LocalAgent\Release\MP.LocalAgent.exe"

New-Service `
  -Name $ServiceName `
  -BinaryPathName $ServicePath `
  -DisplayName "MP Local Agent" `
  -Description "Local agent for MP POS System - manages fiscal devices" `
  -StartupType Automatic

# 3. Uruchom service
Start-Service -Name $ServiceName

# 4. Sprawd≈∫ status
Get-Service -Name $ServiceName
# Powinno byƒá: Status = Running

# 5. Sprawd≈∫ logi
Get-EventLog -LogName Application -Source MPLocalAgent -Newest 5
```

### Usuniƒôcie Service (je≈õli potrzeba)

```bash
# PowerShell (Administrator)
Stop-Service -Name "MPLocalAgent"
Remove-Service -Name "MPLocalAgent"
```

---

## Aktualizacja Agenta

Gdy pojawi siƒô nowa wersja:

```bash
# 1. Zatrzymaj service
Stop-Service -Name "MPLocalAgent"

# 2. Utw√≥rz backup konfiguracji
Copy-Item C:\MP\LocalAgent\Release\appsettings.json `
         C:\MP\LocalAgent\Release\appsettings.json.backup

# 3. Skopiuj nowe pliki
# Pobierz nowy release i skopiuj do: C:\MP\LocalAgent\Release\
# ZACHOWAJ appsettings.json (konfiguracja)

# 4. Uruchom service
Start-Service -Name "MPLocalAgent"

# 5. Sprawd≈∫ logi
tail -f C:\Users\[User]\AppData\Local\MP\LocalAgent\Logs\localagent-*.txt
```

---

## Monitorowanie i Utrzymanie

### Daily Checklist

```bash
# Sprawdzaj co 24h:

# 1. Status Z-Report (kasa fiskalna)
# Powinien byƒá generowany raz dziennie o zamkniƒôciu
curl https://localhost:44377/api/app/fiscal/z-report

# 2. Heartbeat agent'a
# Powinien byƒá co 30 sekund
# Logach: [INF] Heartbeat sent to Azure

# 3. Papier w kasie
# Sprawd≈∫ fizycznie i w Status

# 4. Rozmiar SQLite database
# Nie powinien rosnƒÖƒá (offset commands sƒÖ czyszczone)

# 5. Logi b≈Çƒôd√≥w
# Sprawd≈∫ Logs/ folder - nie powinno byƒá ERR
```

### Monthly Tasks

- Backupuj `appsettings.json`
- Sprawdzaj CRK reconciliation (czy sumy siƒô zgadzajƒÖ)
- Testuj offline mode
- Aktualizuj agent do najnowszej wersji

---

## Wsparcie i Dokumentacja

- **API Documentation**: https://localhost:44377/swagger
- **Agent Status Panel**: https://localhost:44377/admin/agents
- **Fiscal Compliance**: Patrz sekcja CRK w CLAUDE.md
- **Security Keys**: MP-67 Agent Authentication w CLAUDE.md
- **Local Logs**: `C:\Users\[User]\AppData\Local\MP\LocalAgent\Logs\`
